<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>X Layer é“¾ä¸Šæ—¥è®°</title>
  <!-- ä½¿ç”¨æ›´ç¨³å®šçš„ ethers CDN -->
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9fafb; }
    h1 { color: #333; }
    textarea { width: 100%; height: 120px; margin-top: 10px; padding: 10px; }
    button { padding: 10px 20px; margin-top: 10px; cursor: pointer; border: none;
             background: #4f46e5; color: white; border-radius: 8px; font-size: 16px; }
    #status { margin-top: 15px; font-family: monospace; color: #555; }
    .error { color: #dc2626; }
    .success { color: #059669; }
    .warning { color: #d97706; }
  </style>
</head>
<body>
  <h1>ğŸ““ X Layer é“¾ä¸Šæ—¥è®° (Memo)</h1>
  <p>å†™ä¸‹ä½ çš„æ—¥è®°ï¼Œç‚¹å‡»æŒ‰é’®å³å¯é“­åˆ»åœ¨é“¾ä¸Šã€‚</p>
  <textarea id="diary" placeholder="ä»Šå¤©æƒ³è®°å½•ç‚¹ä»€ä¹ˆï¼Ÿ"></textarea><br/>
  <button onclick="sendDiary()" id="submitBtn">âœï¸ é“­åˆ»æ—¥è®°</button>
  <div id="status"></div>

  <script>
    // æ£€æŸ¥ ethers æ˜¯å¦æ­£ç¡®åŠ è½½
    function checkEthers() {
      if (typeof ethers === 'undefined') {
        document.getElementById('status').innerHTML = '<span class="error">âŒ Ethers åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</span>';
        document.getElementById('submitBtn').disabled = true;
        return false;
      }
      return true;
    }

    // è·å–é’±åŒ…æä¾›è€…
    function getWalletProvider() {
      // ä¼˜å…ˆä½¿ç”¨ MetaMask
      if (window.ethereum && window.ethereum.isMetaMask) {
        return window.ethereum;
      }
      // å°è¯•å…¶ä»–é’±åŒ…
      if (window.ethereum) {
        return window.ethereum;
      }
      return null;
    }

    async function sendDiary() {
      const status = document.getElementById("status");
      const diaryText = document.getElementById("diary").value.trim();

      if (!checkEthers()) {
        return;
      }

      if (!diaryText) {
        status.innerHTML = '<span class="warning">âš ï¸ è¯·è¾“å…¥å†…å®¹</span>';
        return;
      }

      const provider = getWalletProvider();
      if (!provider) {
        status.innerHTML = '<span class="error">âŒ è¯·å…ˆå®‰è£… MetaMask æˆ–å…¶ä»–ä»¥å¤ªåŠé’±åŒ…</span>';
        return;
      }

      try {
        // è¯·æ±‚è´¦æˆ·è¿æ¥
        await provider.request({ method: "eth_requestAccounts" });
        
        // ä½¿ç”¨ ethers v5 è¯­æ³•
        const ethersProvider = new ethers.providers.Web3Provider(provider);
        const signer = ethersProvider.getSigner();

        // è½¬ç»™è‡ªå·±åœ°å€
        const to = await signer.getAddress();
        const dataHex = ethers.utils.toUtf8Bytes(diaryText);

        status.innerHTML = '<span class="warning">â³ æ­£åœ¨å‘é€äº¤æ˜“...</span>';

        const tx = await signer.sendTransaction({
          to,
          value: 0,
          data: dataHex
        });

        status.innerHTML = '<span class="warning">â³ äº¤æ˜“å‘é€ä¸­: ' + tx.hash + '</span>';
        
        const receipt = await tx.wait();
        status.innerHTML = '<span class="success">âœ… é“­åˆ»å®Œæˆ! åŒºå—å·: ' + receipt.blockNumber + 
                           '<br>äº¤æ˜“å“ˆå¸Œ: ' + tx.hash + '</span>';
      } catch (err) {
        console.error(err);
        let errorMsg = err.message;
        if (err.code === 4001) {
          errorMsg = "ç”¨æˆ·æ‹’ç»äº†è¿æ¥è¯·æ±‚";
        } else if (err.code === -32002) {
          errorMsg = "è¯·æ£€æŸ¥ MetaMask å¼¹çª—å¹¶ç¡®è®¤è¿æ¥";
        }
        status.innerHTML = '<span class="error">âŒ å‡ºé”™: ' + errorMsg + '</span>';
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥
    window.addEventListener('load', function() {
      if (!checkEthers()) {
        console.error('Ethers library not loaded');
      }
    });
  </script>
</body>
</html>
